<div class="main-container-dashboard">
    <div class="main-container-nav">
        <p class="admin-heading my-auto">ADMIN DASHBOARD</p>
        <input id="search" type="search" class="search" placeholder="search username ....">
    </div>
    <div class="user-container">
        <div class="each-user-container row">
            <div class="col-5">
                <p class="my-auto"><b>username</b></p>
            </div>
            <div class="col-5">
                <p class="my-auto"><b>authorization</b></p>
            </div>
            <div class="col-1">
                <p class="my-auto"><b></b></p>
            </div>
            <div class="col-1">
                <p class="my-auto"><b></b></p>
            </div>
        </div>

        <% usersArray.forEach(function(user) { %>
            <div class="each-user-container row">
                <div class="col-5">
                    <p class="my-auto"><b>
                            <%= user.username %>
                        </b></p>
                </div>
                <div class="col-5">
                    <p class="my-auto"><b>
                            <%= user.authorization %>
                        </b></p>
                </div>
                <div class="col-1">
                    <button id="<%= user.username %>" class="edit icon-wrapper"><img
                            src="http://localhost:3000/images/edit.png" alt="edit"></button>
                </div>
                <div class="col-1">
                    <button id="<%= user.username %>" class="delete icon-wrapper"><img
                            src="http://localhost:3000/images/delete.png" alt="edit" "></button>
                </div>
            </div>
        <% }); %>
    </div>
    <div class=" end-container">
                        <nav aria-label="Page navigation example">
                            <ul class="pagination">
                                <li class="page-item"><button class="page-link" href="#"
                                        onclick="backNavigator('backward')">Previous</button></li>
                                <% for (let i=1; i <=arrayLength; i++) { %>
                                    <li class="page-item"><a class="page-link" href="/admin/dashboard?page=<%= i %>">
                                            <%= i %>
                                        </a></li>
                                    <% } %>
                                <li class="page-item"><button onclick="backNavigator('forward')" class="page-link" href="#">Next</button></li>
                            </ul>
                        </nav>
                </div>
            </div>
            <script>
            function debounce(func, wait, immediate = false) {
                let timeout;

                return function(...args) {
                    const context = this;

                    // Determine if the function should be executed immediately
                    const callNow = immediate && !timeout;

                    // Clear the previous timeout
                    clearTimeout(timeout);

                    // Set a new timeout
                    timeout = setTimeout(() => {
                        if (!immediate) {
                            func.apply(context, args);
                        }
                        timeout = null;
                    }, wait);

                    // Execute the function immediately if 'immediate' is true
                    if (callNow) {
                        func.apply(context, args);
                    }
                };
            }
                const handleInput = debounce(async (event) => {
                    console.log("run")
                    if(event.target.value.length===0){
                        window.location.reload()
                    }
                    //right now its server side after a while make it server
                    let data=await (await fetch(`/admin/user?username=${event.target.value}`)).json()
                    let userArray=data.userArray
                    let parent=document.querySelector(".user-container")
                    if(userArray.length===0){
                        alert("no user found")
                    }else{
                        parent.innerHTML=''

                        userArray.forEach((user) => {
                        
                        let eachuser = document.createElement("div");
                        eachuser.className = "each-user-container row";

                        let usernamediv = document.createElement("div");
                        usernamediv.className = "col-5";

                        let usernameptag = document.createElement("p");
                        usernameptag.className = "my-auto";
                        usernameptag.textContent = user.username;
                        usernameptag.style.fontWeight = "900";

                        let authdiv = document.createElement("div");
                        authdiv.className = "col-5";

                        let authptag = document.createElement("p");
                        authptag.className = "my-auto";
                        authptag.textContent = user.authorization;
                        authptag.style.fontWeight = "900";

                        let editdiv=document.createElement("div")
                        editdiv.className="col-1"

                        let button=document.createElement("button")
                        button.id=user.username
                        button.className="edit icon-wrapper"

                        let image=document.createElement("img")
                        image.src="http://localhost:3000/images/edit.png"

                        button.appendChild(image)


                        let deletediv=document.createElement("div")
                        deletediv.className="col-1"

                        let deletebutton=document.createElement("button")
                        deletebutton.id=user.username
                        deletebutton.className="delete icon-wrapper"

                        let deleteimage=document.createElement("img")
                        deleteimage.src="http://localhost:3000/images/delete.png"

                        deletebutton.appendChild(deleteimage)




                        usernamediv.appendChild(usernameptag);
                        authdiv.appendChild(authptag);
                        editdiv.appendChild(button)
                        deletediv.appendChild(deletebutton)


                        // Append usernamediv before authdiv to ensure correct order
                        eachuser.appendChild(usernamediv);
                        eachuser.appendChild(authdiv);
                        eachuser.appendChild(editdiv)
                        eachuser.appendChild(deletediv)
                        parent.appendChild(eachuser);
                    });
                    }


                    // window.location.href=`/admin/dashboard?username=${event.target.value}`
                }, 1500);
            
                document.querySelector("#search").addEventListener("input",handleInput)
  

                const pageCount = <%= parseInt(arrayLength) %>;
                document.querySelectorAll(".edit").forEach((element) => {
                    element.addEventListener("click", function (e) {
                        //here add code for edit open a popup and then edit
                        console.log(this.id)
                    })
                }
                )
                document.querySelectorAll(".delete").forEach((element) => {
                    element.addEventListener("click", function (e) {
                        console.log(this.id)
                    })
                })
                function backNavigator(direction) {
                    const params = new URLSearchParams(window.location.search);
                    let page = parseInt(params.get('page'))
                    if (page) {
                        //check if its less than minimum
                        if (direction === "backward") {
                            if (page <= 1) {
                                window.location.href = "/admin/dashboard?page=1"
                            } else if (page > 1) {
                                window.location.href = `/admin/dashboard?page=${page - 1}`
                            }
                        } else {
                            //in this context infinity is the size of the array pass 
                            if (page >= pageCount) {
                                window.location.href = `/admin/dashboard?page=${pageCount}`
                            } else if (page < pageCount) {
                                window.location.href = `/admin/dashboard?page=${page + 1}`
                            }
                        }
                    }else{
                        window.location.href="/admin/dashboard?page=2"
                    }
                }


            </script>